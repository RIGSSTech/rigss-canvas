(window["canvasWebpackJsonp"] = window["canvasWebpackJsonp"] || []).push([[3770],{

/***/ "+e2R":
/*!**************************************************!*\
  !*** ./ui/shared/lti/jquery/platform_storage.js ***!
  \**************************************************/
/*! exports provided: getLimit, clearLimit, addToLimit, removeFromLimit, clearData, getData, putData */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"getLimit\", function() { return getLimit; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"clearLimit\", function() { return clearLimit; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"addToLimit\", function() { return addToLimit; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"removeFromLimit\", function() { return removeFromLimit; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"clearData\", function() { return clearData; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"getData\", function() { return getData; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"putData\", function() { return putData; });\n/*\n * Copyright (C) 2021 - present Instructure, Inc.\n *\n * This file is part of Canvas.\n *\n * Canvas is free software: you can redistribute it and/or modify it under\n * the terms of the GNU Affero General Public License as published by the Free\n * Software Foundation, version 3 of the License.\n *\n * Canvas is distributed in the hope that it will be useful, but WITHOUT ANY\n * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR\n * A PARTICULAR PURPOSE. See the GNU Affero General Public License for more\n * details.\n *\n * You should have received a copy of the GNU Affero General Public License along\n * with this program. If not, see <http://www.gnu.org/licenses/>.\n */\nconst STORAGE_CHAR_LIMIT = 4096; // IMS minimum storage limit is 4096 bytes so 4096 chars is more than enough\n\nconst STORAGE_KEY_LIMIT = 500;\nconst limits = {};\n\nconst createLimit = tool_id => {\n  if (!limits[tool_id]) {\n    limits[tool_id] = {\n      keyCount: 0,\n      charCount: 0\n    };\n  }\n};\n\nconst getLimit = tool_id => {\n  createLimit(tool_id);\n  return limits[tool_id];\n};\n\nconst clearLimit = tool_id => {\n  delete limits[tool_id];\n};\n\nconst addToLimit = (tool_id, key, value) => {\n  createLimit(tool_id);\n  const length = key.length + value.length;\n\n  if (limits[tool_id].keyCount >= STORAGE_KEY_LIMIT) {\n    const e = new Error('Reached key limit for tool');\n    e.code = 'storage_exhaustion';\n    throw e;\n  }\n\n  if (limits[tool_id].charCount + length > STORAGE_CHAR_LIMIT) {\n    const e = new Error('Reached byte limit for tool');\n    e.code = 'storage_exhaustion';\n    throw e;\n  }\n\n  limits[tool_id].keyCount++;\n  limits[tool_id].charCount += length;\n};\n\nconst removeFromLimit = (tool_id, key, value) => {\n  limits[tool_id].keyCount--;\n  limits[tool_id].charCount -= key.length + value.length;\n\n  if (limits[tool_id].keyCount < 0) {\n    limits[tool_id].keyCount = 0;\n  }\n\n  if (limits[tool_id].charCount < 0) {\n    limits[tool_id].charCount = 0;\n  }\n};\n\nconst getKey = (tool_id, key) => `lti|platform_storage|${tool_id}|${key}`;\n\nconst putData = (tool_id, key, value) => {\n  addToLimit(tool_id, key, value);\n  window.localStorage.setItem(getKey(tool_id, key), value);\n};\n\nconst getData = (tool_id, key) => window.localStorage.getItem(getKey(tool_id, key));\n\nconst clearData = (tool_id, key) => {\n  const value = getData(tool_id, key);\n\n  if (value) {\n    removeFromLimit(tool_id, key, value);\n    window.localStorage.removeItem(getKey(tool_id, key));\n  }\n};\n\n\n\n//# sourceURL=webpack:///./ui/shared/lti/jquery/platform_storage.js?");

/***/ }),

/***/ "hugc":
/*!*********************************************************************!*\
  !*** ./ui/shared/lti/jquery/subjects/org.imsglobal.lti.put_data.js ***!
  \*********************************************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"default\", function() { return handler; });\n/* harmony import */ var _platform_storage__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../platform_storage */ \"+e2R\");\n/*\n * Copyright (C) 2021 - present Instructure, Inc.\n *\n * This file is part of Canvas.\n *\n * Canvas is free software: you can redistribute it and/or modify it under\n * the terms of the GNU Affero General Public License as published by the Free\n * Software Foundation, version 3 of the License.\n *\n * Canvas is distributed in the hope that it will be useful, but WITHOUT ANY\n * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR\n * A PARTICULAR PURPOSE. See the GNU Affero General Public License for more\n * details.\n *\n * You should have received a copy of the GNU Affero General Public License along\n * with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nfunction handler({\n  message,\n  responseMessages,\n  event\n}) {\n  const {\n    key,\n    value\n  } = message;\n\n  if (!key) {\n    responseMessages.sendBadRequestError(\"Missing required 'key' field\");\n    return true;\n  }\n\n  if (value) {\n    try {\n      Object(_platform_storage__WEBPACK_IMPORTED_MODULE_0__[\"putData\"])(event.origin, key, value);\n      responseMessages.sendResponse({\n        key,\n        value\n      });\n    } catch (e) {\n      responseMessages.sendError(e.code, e.message);\n    }\n  } else {\n    Object(_platform_storage__WEBPACK_IMPORTED_MODULE_0__[\"clearData\"])(event.origin, key);\n    responseMessages.sendResponse({\n      key\n    });\n  }\n\n  return true;\n}\n\n//# sourceURL=webpack:///./ui/shared/lti/jquery/subjects/org.imsglobal.lti.put_data.js?");

/***/ }),

/***/ "mElt":
/*!************************************************************************************!*\
  !*** ./ui/shared/lti/jquery/subjects/__tests__/org.imsglobal.lti.put_data.test.js ***!
  \************************************************************************************/
/*! no exports provided */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _org_imsglobal_lti_put_data__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../org.imsglobal.lti.put_data */ \"hugc\");\n/* harmony import */ var _platform_storage__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../platform_storage */ \"+e2R\");\n/*\n * Copyright (C) 2021 - present Instructure, Inc.\n *\n * This file is part of Canvas.\n *\n * Canvas is free software: you can redistribute it and/or modify it under\n * the terms of the GNU Affero General Public License as published by the Free\n * Software Foundation, version 3 of the License.\n *\n * Canvas is distributed in the hope that it will be useful, but WITHOUT ANY\n * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR\n * A PARTICULAR PURPOSE. See the GNU Affero General Public License for more\n * details.\n *\n * You should have received a copy of the GNU Affero General Public License along\n * with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\n\ndescribe('org.imsglobal.lti.put_data handler', () => {\n  let message;\n  let responseMessages;\n  let event;\n  beforeEach(() => {\n    responseMessages = {\n      sendBadRequestError: jest.fn(),\n      sendResponse: jest.fn(),\n      sendError: jest.fn()\n    };\n    event = {\n      origin: 'http://example.com'\n    };\n    jest.spyOn(_platform_storage__WEBPACK_IMPORTED_MODULE_1__, 'clearData').mockImplementation(() => {});\n    jest.spyOn(_platform_storage__WEBPACK_IMPORTED_MODULE_1__, 'putData').mockImplementation(() => {});\n  });\n  afterEach(() => {\n    _platform_storage__WEBPACK_IMPORTED_MODULE_1__[\"clearData\"].mockRestore();\n    _platform_storage__WEBPACK_IMPORTED_MODULE_1__[\"putData\"].mockRestore();\n  });\n  describe('when key is not present', () => {\n    beforeEach(() => {\n      message = {};\n    });\n    it('sends bad request error postMessage', () => {\n      Object(_org_imsglobal_lti_put_data__WEBPACK_IMPORTED_MODULE_0__[\"default\"])({\n        message,\n        responseMessages,\n        event\n      });\n      expect(responseMessages.sendBadRequestError).toHaveBeenCalledWith(\"Missing required 'key' field\");\n    });\n  });\n  describe('when value is not present', () => {\n    beforeEach(() => {\n      message = {\n        key: 'hello'\n      };\n    });\n    it('clears data from platform storage', () => {\n      Object(_org_imsglobal_lti_put_data__WEBPACK_IMPORTED_MODULE_0__[\"default\"])({\n        message,\n        responseMessages,\n        event\n      });\n      expect(_platform_storage__WEBPACK_IMPORTED_MODULE_1__[\"clearData\"]).toHaveBeenCalled();\n    });\n    it('sends response postMessage with only key', () => {\n      Object(_org_imsglobal_lti_put_data__WEBPACK_IMPORTED_MODULE_0__[\"default\"])({\n        message,\n        responseMessages,\n        event\n      });\n      expect(responseMessages.sendResponse).toHaveBeenCalledWith(message);\n    });\n  });\n  describe('when key and value are present', () => {\n    beforeEach(() => {\n      message = {\n        key: 'hello',\n        value: 'world'\n      };\n    });\n    it('puts data in platform storage', () => {\n      Object(_org_imsglobal_lti_put_data__WEBPACK_IMPORTED_MODULE_0__[\"default\"])({\n        message,\n        responseMessages,\n        event\n      });\n      expect(_platform_storage__WEBPACK_IMPORTED_MODULE_1__[\"putData\"]).toHaveBeenCalledWith(event.origin, message.key, message.value);\n    });\n    it('sends response postMessage with key and value', () => {\n      Object(_org_imsglobal_lti_put_data__WEBPACK_IMPORTED_MODULE_0__[\"default\"])({\n        message,\n        responseMessages,\n        event\n      });\n      expect(responseMessages.sendResponse).toHaveBeenCalledWith(message);\n    });\n  });\n  describe('when platform storage throws an error with a code', () => {\n    const errorMessage = 'message';\n    const code = 'code';\n    beforeEach(() => {\n      _platform_storage__WEBPACK_IMPORTED_MODULE_1__[\"putData\"].mockRestore();\n      jest.spyOn(_platform_storage__WEBPACK_IMPORTED_MODULE_1__, 'putData').mockImplementation(() => {\n        const e = new Error(errorMessage);\n        e.code = code;\n        throw e;\n      });\n    });\n    it('includes code in error response postMessage', () => {\n      Object(_org_imsglobal_lti_put_data__WEBPACK_IMPORTED_MODULE_0__[\"default\"])({\n        message,\n        responseMessages,\n        event\n      });\n      expect(responseMessages.sendError).toHaveBeenCalledWith(code, errorMessage);\n    });\n  });\n});\n\n//# sourceURL=webpack:///./ui/shared/lti/jquery/subjects/__tests__/org.imsglobal.lti.put_data.test.js?");

/***/ })

}]);